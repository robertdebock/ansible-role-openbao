---

- name: assert | Test openbao_version
  ansible.builtin.assert:
    that:
      - openbao_version is defined
      - openbao_version is string
      - openbao_version | length > 0
    quiet: true

- name: assert | Test openbao_download_dir
  ansible.builtin.assert:
    that:
      - openbao_download_dir is defined
      - openbao_download_dir is string
      - openbao_download_dir | length > 0
    quiet: true

- name: assert | Test openbao_ui
  ansible.builtin.assert:
    that:
      - openbao_ui is defined
      - openbao_ui is boolean
    quiet: true

- name: assert | Test openbao_storage
  ansible.builtin.assert:
    that:
      - openbao_storage is defined
      - openbao_storage is mapping
      - openbao_storage.type is defined
      - openbao_storage.type is string
      - openbao_storage.type in [ 'file', 'inmem', 'raft', 'postgresql' ]
    quiet: true

- name: assert | Test openbao_storage file parameters
  ansible.builtin.assert:
    that:
      - openbao_storage.path is defined
      - openbao_storage.path is string
      - openbao_storage.path | length > 0
    quiet: true
  when:
    - openbao_storage.type == 'file'

- name: assert | Test openbao_storage raft parameters
  ansible.builtin.assert:
    that:
      - openbao_storage.path is defined
      - openbao_storage.path is string
      - openbao_storage.path | length > 0
      - openbao_storage.node_id is defined
      - openbao_storage.node_id is string
      - openbao_storage.node_id | length > 0
    quiet: true
  when:
    - openbao_storage.type == 'raft'

- name: assert | Test cluster address for raft storage
  ansible.builtin.assert:
    that:
      - openbao_cluster_addr is defined
      - openbao_cluster_addr is string
      - openbao_cluster_addr | length > 0
    quiet: true
  when:
    - openbao_storage.type == 'raft'

- name: assert | Test API address for raft storage
  ansible.builtin.assert:
    that:
      - openbao_api_addr is defined
      - openbao_api_addr is string
      - openbao_api_addr | length > 0
    quiet: true
  when:
    - openbao_storage.type == 'raft'

- name: assert | Test openbao_storage postgresql parameters
  ansible.builtin.assert:
    that:
      - openbao_storage.connection_url is defined
      - openbao_storage.connection_url is string
      - openbao_storage.connection_url | length > 0
    quiet: true
  when:
    - openbao_storage.type == 'postgresql'

- name: assert | Test openbao_listeners
  ansible.builtin.assert:
    that:
      - openbao_listeners is defined
      - openbao_listeners is iterable
      - openbao_listeners | length > 0
    quiet: true

- name: assert | Test each listener
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.name is string
      - item.name | length > 0
      - item.address is defined
      - item.address is string
      - item.address | length > 0
    quiet: true
  loop: "{{ openbao_listeners }}"
  loop_control:
    label: "{{ item.name }}"

- name: assert | Test proxy_protocol parameters for listeners
  ansible.builtin.assert:
    that:
      - (item.proxy_protocol_behavior is not defined) or (item.proxy_protocol_behavior in [ 'use_always', 'allow_authorized', 'deny_unauthorized' ])
      - (item.proxy_protocol_authorized_addrs is not defined) or (item.proxy_protocol_authorized_addrs is string)
    quiet: true
  loop: "{{ openbao_listeners }}"
  loop_control:
    label: "{{ item.name }}"

- name: assert | Test openbao_seal
  ansible.builtin.assert:
    that:
      - openbao_seal is defined
      - openbao_seal is iterable
    quiet: true

- name: assert | Test each seal (if any)
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.name is string
      - item.name | length > 0
      - item.name in [ 'awskms', 'alicloudkms', 'azurekeyvault', 'gcpckms', 'kmip', 'ocikms', 'pkcs11', 'transit', 'static' ]
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0

- name: assert | Test AWS KMS seal parameters
  ansible.builtin.assert:
    that:
      - item.region is defined
      - item.region is string
      - item.region | length > 0
      - item.kms_key_id is defined
      - item.kms_key_id is string
      - item.kms_key_id | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'awskms'

- name: assert | Test AliCloud KMS seal parameters
  ansible.builtin.assert:
    that:
      - item.region is defined
      - item.region is string
      - item.region | length > 0
      - item.key_id is defined
      - item.key_id is string
      - item.key_id | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'alicloudkms'

- name: assert | Test Azure Key Vault seal parameters
  ansible.builtin.assert:
    that:
      - item.tenant_id is defined
      - item.tenant_id is string
      - item.tenant_id | length > 0
      - item.vault_name is defined
      - item.vault_name is string
      - item.vault_name | length > 0
      - item.key_name is defined
      - item.key_name is string
      - item.key_name | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'azurekeyvault'

- name: assert | Test Azure Key Vault seal client_id (if provided)
  ansible.builtin.assert:
    that:
      - item.client_id is string
      - item.client_id | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'azurekeyvault'
    - item.client_id is defined

- name: assert | Test Azure Key Vault seal client_secret (if provided)
  ansible.builtin.assert:
    that:
      - item.client_secret is string
      - item.client_secret | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'azurekeyvault'
    - item.client_secret is defined

- name: assert | Test GCP Cloud KMS seal parameters
  ansible.builtin.assert:
    that:
      - item.project is defined
      - item.project is string
      - item.project | length > 0
      - item.region is defined
      - item.region is string
      - item.region | length > 0
      - item.key_ring is defined
      - item.key_ring is string
      - item.key_ring | length > 0
      - item.crypto_key is defined
      - item.crypto_key is string
      - item.crypto_key | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'gcpckms'

- name: assert | Test KMIP seal parameters
  ansible.builtin.assert:
    that:
      - item.server is defined
      - item.server is string
      - item.server | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'kmip'

- name: assert | Test OCI KMS seal parameters
  ansible.builtin.assert:
    that:
      - item.key_id is defined
      - item.key_id is string
      - item.key_id | length > 0
      - item.crypto_endpoint is defined
      - item.crypto_endpoint is string
      - item.crypto_endpoint | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'ocikms'

- name: assert | Test PKCS#11 seal parameters
  ansible.builtin.assert:
    that:
      - item.lib is defined
      - item.lib is string
      - item.lib | length > 0
      - item.slot is defined
      - item.slot is string
      - item.slot | length > 0
      - item.pin is defined
      - item.pin is string
      - item.pin | length > 0
      - item.key_label is defined
      - item.key_label is string
      - item.key_label | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'pkcs11'

- name: assert | Test Transit seal parameters
  ansible.builtin.assert:
    that:
      - item.address is defined
      - item.address is string
      - item.address | length > 0
      - item.token is defined
      - item.token is string
      - item.token | length > 0
      - item.key_name is defined
      - item.key_name is string
      - item.key_name | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'transit'

- name: assert | Test Static seal parameters
  ansible.builtin.assert:
    that:
      - item.current_key_id is defined
      - item.current_key_id is string
      - item.current_key_id | length > 0
      - item.current_key is defined
      - item.current_key is string
      - item.current_key | length > 0
    quiet: true
  loop: "{{ openbao_seal }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - openbao_seal | length > 0
    - item.name == 'static'

- name: assert | Test openbao_telemetry
  ansible.builtin.assert:
    that:
      - openbao_telemetry is defined
      - openbao_telemetry is mapping
    quiet: true

- name: assert | Test openbao_log_requests_level
  ansible.builtin.assert:
    that:
      - openbao_log_requests_level is defined
      - openbao_log_requests_level is string
      - openbao_log_requests_level in [ 'error', 'warn', 'info', 'debug', 'trace', 'off' ]
    quiet: true

- name: assert | Test openbao_plugin_directory
  ansible.builtin.assert:
    that:
      - openbao_plugin_directory is defined
      - openbao_plugin_directory is string
      - openbao_plugin_directory | length > 0
    quiet: true

- name: assert | Test openbao_plugin_validate_certs
  ansible.builtin.assert:
    that:
      - openbao_plugin_validate_certs is defined
      - openbao_plugin_validate_certs is boolean
    quiet: true

- name: assert | Test openbao_plugins type
  ansible.builtin.assert:
    that:
      - openbao_plugins is defined
      - openbao_plugins is iterable
    quiet: true

- name: assert | Test each plugin item (if any)
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.name is string
      - item.name | length > 0
      - item.version is defined
      - item.version is string
      - item.version | length > 0
      - item.download_url is defined
      - item.download_url is string
      - item.download_url | length > 0
    quiet: true
  loop: "{{ openbao_plugins }}"
  loop_control:
    label: "{{ item.name | default('unnamed') }}"
  when:
    - openbao_plugins | length > 0

- name: assert | Test openbao_tls
  ansible.builtin.assert:
    that:
      - openbao_tls is defined
      - openbao_tls is mapping
    quiet: true

- name: assert | Test openbao_tls directory parameter
  ansible.builtin.assert:
    that:
      - openbao_tls.directory is defined
      - openbao_tls.directory is string
      - openbao_tls.directory | length > 0
    quiet: true
  when:
    - openbao_tls | length > 0
    - openbao_tls.directory is defined

- name: assert | Test openbao_tls certificate content
  ansible.builtin.assert:
    that:
      - openbao_tls.cert_content is defined
      - openbao_tls.cert_content is string
      - openbao_tls.cert_content | length > 0
    quiet: true
  when:
    - openbao_tls | length > 0
    - openbao_tls.cert_content is defined

- name: assert | Test openbao_tls private key content
  ansible.builtin.assert:
    that:
      - openbao_tls.key_content is defined
      - openbao_tls.key_content is string
      - openbao_tls.key_content | length > 0
    quiet: true
  when:
    - openbao_tls | length > 0
    - openbao_tls.key_content is defined

- name: assert | Test openbao_tls CA certificate content
  ansible.builtin.assert:
    that:
      - openbao_tls.ca_content is defined
      - openbao_tls.ca_content is string
      - openbao_tls.ca_content | length > 0
    quiet: true
  when:
    - openbao_tls | length > 0
    - openbao_tls.ca_content is defined

- name: assert | Test openbao_audit_devices
  ansible.builtin.assert:
    that:
      - openbao_audit_devices is defined
      - openbao_audit_devices is iterable
    quiet: true

- name: assert | Test each audit device (if any)
  ansible.builtin.assert:
    that:
      - item.type is defined
      - item.type is string
      - item.type | length > 0
      - item.type in [ 'file', 'syslog', 'socket' ]
      - item.path is defined
      - item.path is string
      - item.path | length > 0
    quiet: true
  loop: "{{ openbao_audit_devices }}"
  loop_control:
    label: "{{ item.type }}:{{ item.path }}"
  when:
    - openbao_audit_devices | length > 0

- name: assert | Test openbao_initialize type
  ansible.builtin.assert:
    that:
      - openbao_initialize is defined
      - openbao_initialize is iterable
    quiet: true

- name: assert | Gate self-init requires a seal (auto-unseal)
  ansible.builtin.assert:
    that:
      - openbao_seal | length > 0
    fail_msg: "Self-initialization requires auto-unseal to be configured (openbao_seal). See RFC self-init."
    quiet: true
  when:
    - openbao_initialize | length > 0

- name: assert | Validate initialize blocks
  ansible.builtin.assert:
    that:
      - item.name is defined
      - item.name is string
      - (item.requests is not defined) or (item.requests is iterable)
    quiet: true
  loop: "{{ openbao_initialize }}"
  loop_control:
    label: "{{ item.name | default('unnamed') }}"
  when:
    - openbao_initialize | length > 0

- name: assert | Validate initialize requests
  ansible.builtin.assert:
    that:
      - item.1.name is defined
      - item.1.name is string
      - item.1.operation is defined
      - item.1.operation is string
      - item.1.path is defined
      - item.1.path is string
      - (item.1.data is not defined) or (item.1.data is mapping)
    quiet: true
  with_subelements:
    - "{{ openbao_initialize }}"
    - requests
  loop_control:
    label: "{{ item.0.name | default('unnamed') }} -> {{ item.1.name | default('unnamed') }}"
  when:
    - openbao_initialize | length > 0
    - item.0.requests is defined

- name: assert | Validate initialize data eval objects
  ansible.builtin.assert:
    that:
      - item.value.eval_type is defined
      - item.value.eval_source is defined
    quiet: true
  loop: "{{ openbao_initialize
    | map(attribute='requests') | sum(start=[])
    | selectattr('data', 'defined')
    | map(attribute='data')
    | map('dict2items') | sum(start=[]) }}"
  loop_control:
    label: "{{ item.key }}"
  when:
    - openbao_initialize | length > 0
    - item.value is mapping

- name: assert | Validate eval_source=env requires env_var
  ansible.builtin.assert:
    that:
      - item.value.env_var is defined
      - item.value.env_var is string
      - item.value.env_var | length > 0
    quiet: true
    fail_msg: "eval_source=env requires env_var to be defined"
  loop: "{{ openbao_initialize
    | map(attribute='requests') | sum(start=[])
    | selectattr('data', 'defined')
    | map(attribute='data')
    | map('dict2items') | sum(start=[]) }}"
  loop_control:
    label: "{{ item.key }}"
  when:
    - openbao_initialize | length > 0
    - item.value is mapping
    - item.value.eval_source is defined
    - item.value.eval_source == 'env'

- name: assert | Validate eval_source=env require_present is boolean if defined
  ansible.builtin.assert:
    that:
      - item.value.require_present is boolean
    quiet: true
    fail_msg: "eval_source=env require_present must be a boolean if defined"
  loop: "{{ openbao_initialize
    | map(attribute='requests') | sum(start=[])
    | selectattr('data', 'defined')
    | map(attribute='data')
    | map('dict2items') | sum(start=[]) }}"
  loop_control:
    label: "{{ item.key }}"
  when:
    - openbao_initialize | length > 0
    - item.value is mapping
    - item.value.eval_source is defined
    - item.value.eval_source == 'env'
    - item.value.require_present is defined

- name: assert | Validate eval_source=file requires path
  ansible.builtin.assert:
    that:
      - item.value.path is defined
      - item.value.path is string
      - item.value.path | length > 0
    quiet: true
    fail_msg: "eval_source=file requires path to be defined"
  loop: "{{ openbao_initialize
    | map(attribute='requests') | sum(start=[])
    | selectattr('data', 'defined')
    | map(attribute='data')
    | map('dict2items') | sum(start=[]) }}"
  loop_control:
    label: "{{ item.key }}"
  when:
    - openbao_initialize | length > 0
    - item.value is mapping
    - item.value.eval_source is defined
    - item.value.eval_source == 'file'

- name: assert | Validate eval_source=request requires initialize_name, request_name, field_selector
  ansible.builtin.assert:
    that:
      - item.value.initialize_name is defined
      - item.value.initialize_name is string
      - item.value.initialize_name | length > 0
      - item.value.request_name is defined
      - item.value.request_name is string
      - item.value.request_name | length > 0
      - item.value.field_selector is defined
      - item.value.field_selector is string or item.value.field_selector is sequence
      - (item.value.field_selector is string and item.value.field_selector | length > 0) or (item.value.field_selector is sequence and item.value.field_selector | length > 0)
    quiet: true
    fail_msg: "eval_source=request requires initialize_name, request_name, and non-empty field_selector"
  loop: "{{ openbao_initialize
    | map(attribute='requests') | sum(start=[])
    | selectattr('data', 'defined')
    | map(attribute='data')
    | map('dict2items') | sum(start=[]) }}"
  loop_control:
    label: "{{ item.key }}"
  when:
    - openbao_initialize | length > 0
    - item.value is mapping
    - item.value.eval_source is defined
    - item.value.eval_source == 'request'

- name: assert | Validate eval_source=response requires initialize_name, response_name, field_selector
  ansible.builtin.assert:
    that:
      - item.value.initialize_name is defined
      - item.value.initialize_name is string
      - item.value.initialize_name | length > 0
      - item.value.response_name is defined
      - item.value.response_name is string
      - item.value.response_name | length > 0
      - item.value.field_selector is defined
      - item.value.field_selector is string or item.value.field_selector is sequence
      - (item.value.field_selector is string and item.value.field_selector | length > 0) or (item.value.field_selector is sequence and item.value.field_selector | length > 0)
    quiet: true
    fail_msg: "eval_source=response requires initialize_name, response_name, and non-empty field_selector"
  loop: "{{ openbao_initialize
    | map(attribute='requests') | sum(start=[])
    | selectattr('data', 'defined')
    | map(attribute='data')
    | map('dict2items') | sum(start=[]) }}"
  loop_control:
    label: "{{ item.key }}"
  when:
    - openbao_initialize | length > 0
    - item.value is mapping
    - item.value.eval_source is defined
    - item.value.eval_source == 'response'

- name: assert | Test file audit device parameters
  ansible.builtin.assert:
    that:
      - item.options is defined
      - item.options is mapping
      - item.options.file_path is defined
      - item.options.file_path is string
      - item.options.file_path | length > 0
    quiet: true
  loop: "{{ openbao_audit_devices }}"
  loop_control:
    label: "{{ item.type }}:{{ item.path }}"
  when:
    - openbao_audit_devices | length > 0
    - item.type == 'file'
    - item.options is defined

- name: assert | Test syslog audit device parameters
  ansible.builtin.assert:
    that:
      - item.options is defined
      - item.options is mapping
      - item.options.facility is defined
      - item.options.facility is string
      - item.options.facility | length > 0
    quiet: true
  loop: "{{ openbao_audit_devices }}"
  loop_control:
    label: "{{ item.type }}:{{ item.path }}"
  when:
    - openbao_audit_devices | length > 0
    - item.type == 'syslog'
    - item.options is defined

- name: assert | Test socket audit device parameters
  ansible.builtin.assert:
    that:
      - item.options is defined
      - item.options is mapping
      - item.options.address is defined
      - item.options.address is string
      - item.options.address | length > 0
      - item.options.socket_type is defined
      - item.options.socket_type is string
      - item.options.socket_type in [ 'tcp', 'udp' ]
    quiet: true
  loop: "{{ openbao_audit_devices }}"
  loop_control:
    label: "{{ item.type }}:{{ item.path }}"
  when:
    - openbao_audit_devices | length > 0
    - item.type == 'socket'
    - item.options is defined

- name: assert | Test openbao_service_environment
  ansible.builtin.assert:
    that:
      - openbao_service_environment is defined
      - openbao_service_environment is mapping
    quiet: true

- name: assert | Test openbao_service_environment_persist
  ansible.builtin.assert:
    that:
      - openbao_service_environment_persist is defined
      - openbao_service_environment_persist is boolean
    quiet: true
